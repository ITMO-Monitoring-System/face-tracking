# Документация сервиса Face Tracking

## Обзор сервиса

Проект представляет собой систему отслеживания лиц в реальном времени с возможностью потоковой передачи видео, обнаружения лиц и интеграции с внешними сервисами через RabbitMQ.

## Архитектура

### Основные компоненты

1. **Камера/Видеоисточник** - получает видеопоток с локальной камеры или RTSP-источника
2. **Детектор лиц** - использует Haar-каскады для обнаружения лиц в кадре
3. **Сервер FastAPI** - предоставляет REST API и WebSocket для управления и потоковой передачи
4. **RabbitMQ** - брокер сообщений для обмена данными о обнаруженных лицах
5. **MediaMTX** - медиасервер для приема и трансляции RTSP-потоков
6. **Внешний сервис** - система анализа лиц (подключается к очереди RabbitMQ)

## Поток данных

```
Локальная камера/RTSP источник → MediaMTX → Face Tracking Service → RabbitMQ → Внешний сервис анализа
                                    ↑
                             Веб-интерфейс ← FastAPI Server
```

## Функциональность

### Основные возможности

1. **Прием видеопотока** с различных источников:
   - Локальная веб-камера (по ID: 0, 1, 2...)
   - RTSP поток (например, с IP-камеры)
   - Отключение камеры (значение "none")

2. **Обнаружение лиц** в реальном времени с использованием OpenCV Haar-каскадов

3. **Управление лекциями**:
   - Создание очереди RabbitMQ для каждой лекции
   - Автоматическое уведомление внешнего сервиса о начале лекции
   - Публикация обнаруженных лиц в соответствующую очередь

4. **Потоковая передача** через WebSocket:
   - Аннотированное видео с выделенными лицами
   - Автоматическая публикация лиц раз в 10 секунд
   - Ручной запрос на распознавание

5. **Отказоустойчивость**:
   - Автоподключение при потере видеопотока
   - Управление переподключениями к камере
   - Обработка ошибок внешних сервисов

## Запуск системы

### Требования

- Docker и Docker Compose
- Python 3.8+ (для локальной разработки)

### Быстрый запуск

```bash
# Клонирование проекта и запуск всех сервисов
docker compose up -d --build
```

### Проверка работоспособности

1. **Health check**: `http://сервер:8000/health`
2. **Список активных лекций**: `http://сервер:8000/api/lectures`
3. **Веб-интерфейс**: `http://сервер:8000/`

### Настройка видеоисточника

Система поддерживает несколько типов источников:

1. **Локальная камера**: установить `CAMERA_SOURCE=0` (или 1, 2...)
2. **RTSP поток**: установить `CAMERA_SOURCE=rtsp://адрес:порт/путь`
3. **Отключение**: установить `CAMERA_SOURCE=none`

## Интеграция с внешними сервисами

### Подключение внешнего сервиса анализа

1. **При старте лекции** система автоматически уведомляет внешний сервис:
   - URL: настраивается через `CONNECT_SERVICE_URL`
   - Передает параметры подключения к очереди RabbitMQ

2. **Внешний сервис** должен:
   - Подписаться на указанную очередь RabbitMQ
   - Обрабатывать сообщения с изображениями лиц
   - Возвращать результаты анализа (в отдельной очереди, если настроено)

### Формат сообщений

Сообщения в RabbitMQ содержат:
- Изображение лица в base64
- Метаданные (время, bounding box, ID лекции)
- Информация о источнике видео

## Управление лекциями

### REST API

- `POST /api/lectures/{lecture_id}/start` - начать лекцию
- `POST /api/lectures/{lecture_id}/end` - завершить лекцию
- `GET /api/lectures` - список активных лекций

### WebSocket поток

- `ws://сервер:8000/ws/stream?lecture_id={id}` - поток аннотированного видео
- Поддерживает команды (например, принудительное распознавание)

## Настройка окружения

### Ключевые переменные

```bash
# Источник видео
CAMERA_SOURCE="rtsp://mediamtx:8554/lecture"

# Качество и производительность
FPS="15"
JPEG_QUALITY="80"
AUTO_PUBLISH_INTERVAL="10.0"

# RabbitMQ
RABBITMQ_URL="amqp://guest:guest@rabbitmq:5672/"
RABBITMQ_EXCHANGE="faces"

# Внешний сервис
CONNECT_SERVICE_URL="http://внешний-сервис/api/lecture/start"
CONNECT_SERVICE_THRESHOLD="0.45"
```

## Мониторинг и отладка

### Логи

```bash
# Просмотр логов всех сервисов
docker compose logs -f

# Логи конкретного сервиса
docker compose logs -f face_tracking
```

### Проверка подключений

1. **RabbitMQ Management**: `http://сервер:15673` (guest/guest)
2. **MediaMTX**: `http://сервер:9999` (веб-интерфейс)
3. **Статус очередей**: через RabbitMQ UI или API

## Рекомендации по использованию

### Для потоковой передачи с ноутбука

Используйте ffmpeg для трансляции видео на сервер:

```bash
ffmpeg -f avfoundation -framerate 30 -video_size 1280x720 -i "0" \
  -c:v h264_videotoolbox -b:v 1000k -f rtsp -rtsp_transport tcp \
  "rtsp://сервер:8554/lecture"
```

### Для работы с IP-камерами

1. Убедитесь, что камера поддерживает RTSP
2. Настройте `CAMERA_SOURCE` на RTSP URL камеры
3. При необходимости настройте параметры подключения через `OPENCV_FFMPEG_CAPTURE_OPTIONS`
